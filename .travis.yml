language: node_js
dist: trusty

node_js:
  - "6"

env:
  - PUBLISH_DIR=$TRAVIS_BUILD_DIR/gh-pages

addons:
  organization: cychop-github
  sonarcloud:
    token: $SONARQUBE_TOKEN
    branches:
      - master

cache:
  yarn: true
  directories:
    - node_modules

install:
  - yarn install

# start virtual display for testing
before_script:
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start

script:
  - node node_modules/gulp/bin/gulp.js --color ci
  - sonar-scanner

# deploy to Github Pages if build was successful
after_success:
  if [ $TRAVIS_BRANCH == 'master' -a $TRAVIS_PUBLISH_PAGES == 'true' -a -n $GITHUB_API_KEY ]; then
    git clone https://github.com/$TRAVIS_REPO_SLUG.git --branch gh-pages "$PUBLISH_DIR"
    make publish
    cd "$PUBLISH_DIR"
    git add --all
    git -c user.name='Travis CI' -c user.email='travis' commit -m "Travis build $TRAVIS_BUILD_NUMBER"
    git push -q https://cyChop:$GITHUB_API_KEY@github.com/$TRAVIS_REPO_SLUG.git
    cd $TRAVIS_BUILD_DIR
  fi
